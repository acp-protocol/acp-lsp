// ==============================================================================
// ACP Language Server - Main Entry Point
// ==============================================================================
// Generated by SpecKit: /project init
// ==============================================================================

import {
  createConnection,
  TextDocuments,
  ProposedFeatures,
  InitializeParams,
  InitializeResult,
  TextDocumentSyncKind,
  DidChangeConfigurationNotification,
} from 'vscode-languageserver/node';

import { TextDocument } from 'vscode-languageserver-textdocument';
import { createCapabilities } from './capabilities';
import { DocumentManager } from './documents/manager';
import { ConfigurationStore } from './services/configuration';
import { DiagnosticsProvider } from './providers/diagnostics';
import { Logger, LogLevel } from './utils/logger';

// Create connection
const connection = createConnection(ProposedFeatures.all);
const documents = new TextDocuments(TextDocument);

// Services
let logger: Logger;
let documentManager: DocumentManager;
let configStore: ConfigurationStore;
let diagnosticsProvider: DiagnosticsProvider;

// Capability flags
let hasConfigurationCapability = false;
let hasWorkspaceFolderCapability = false;

connection.onInitialize((params: InitializeParams): InitializeResult => {
  logger = new Logger(connection.console);
  logger.setLevel(LogLevel.Info);
  logger.info('ACP Language Server initializing...');

  const capabilities = params.capabilities;
  
  hasConfigurationCapability = !!(
    capabilities.workspace && !!capabilities.workspace.configuration
  );
  hasWorkspaceFolderCapability = !!(
    capabilities.workspace && !!capabilities.workspace.workspaceFolders
  );

  // Initialize services
  configStore = new ConfigurationStore(connection, hasConfigurationCapability);
  documentManager = new DocumentManager(documents, logger);
  diagnosticsProvider = new DiagnosticsProvider(connection, documentManager, logger);

  logger.info('Services initialized');

  return createCapabilities({
    hasWorkspaceFolderCapability,
    hasConfigurationCapability,
  });
});

connection.onInitialized(async () => {
  logger.info('ACP Language Server initialized');

  if (hasConfigurationCapability) {
    connection.client.register(DidChangeConfigurationNotification.type, undefined);
  }

  await configStore.initialize();
});

connection.onShutdown(() => {
  logger.info('ACP Language Server shutting down');
});

// Document handlers
documents.onDidOpen((event) => {
  logger.debug(`Document opened: ${event.document.uri}`);
  diagnosticsProvider.validate(event.document);
});

documents.onDidChangeContent((change) => {
  diagnosticsProvider.validate(change.document);
});

documents.onDidClose((event) => {
  logger.debug(`Document closed: ${event.document.uri}`);
  diagnosticsProvider.clear(event.document.uri);
});

// Start server
documents.listen(connection);
connection.listen();

logger.info('ACP Language Server started');
